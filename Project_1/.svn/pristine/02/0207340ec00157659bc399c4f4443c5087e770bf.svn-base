"undefined"==typeof DW&&(DW={}),DW.Chat={Host:realtimeDomain+"/chat",Connection:null,ActiveConversationId:"",EnableScroll:!0,IsActiveWindows:!1,InitTitle:"Hỗ trợ trực tuyến",BlinkTitleInterval:null,ProcessUI:function(){var e=this;e.InitEmoticon(),e.UploadManager.Init(),document.execCommand("defaultParagraphSeparator",!1,"p"),e.Editor.placeCaretAtEnd($("#dchat-input-area").get(0)),$("#dchat-input-area").blur(),$("#dchat-left, #dchat-right").css({height:$(window).height()}),$("#dchat-left-conversation-list-wrapper").css({height:$(window).height()-$("#dchat-left-header").height()}),$("#dchat-info").css({height:$(window).height()}),$("#dchat-message-list").css({height:$(window).height()-50-50}),$("#dchat-show-hide-info").off("click").on("click",function(){$(this).toggleClass("active"),$("#dchat-info").toggleClass("active"),$("#dchat-main-left").toggleClass("minimized")}),$("#dchat-filter-conversation").off("click").on("click",function(){$(this).toggleClass("active"),$("#dchat-filter-select").toggleClass("active")}),$("[contenteditable='true']").off("focus").on("focus",function(){var e=$(this);0==$("br",e).length&&""==$.trim(e.text())&&0==$(".emoticon",e).length&&e.html(e.html()+"<br/>")}),$("[contenteditable='true']").off("blur").on("blur",function(){e.Editor.saveSelection();var t=$(this);t.text().trim().length||0!=$(".emoticon",t).length||t.empty()}),$("#dchat-input-func span.emoticon").off("click").on("click",function(){$(this).toggleClass("active"),$(".dchat-popbox.pre-message-select").addClass("popbox-hide"),$(".dchat-popbox.emoticon-select").toggleClass("popbox-hide")}),$("#dchat-input-func span.pre-message").off("click").on("click",function(){e.InitPreMessage({fullname:$("#dchat-right-header h3").text()}),$(this).toggleClass("active"),$(".dchat-popbox.emoticon-select").addClass("popbox-hide"),$(".dchat-popbox.pre-message-select").toggleClass("popbox-hide")}),$("#dchat-message-list").on("scroll",function(t){var n,a,i,o;n=$(this),o=n.scrollTop(),i=n.prop("scrollHeight"),a=n.height(),o<i-a-50&&(e.EnableScroll=!1),o>i-a-30&&(e.EnableScroll=!0)}),$(window).on("blur focus",function(t){if($(this).data("prevType")!=t.type)switch(t.type){case"blur":e.IsActiveWindows=!1;break;case"focus":e.IsActiveWindows=!0}$(this).data("prevType",t.type)})},InitDesktopNotify:function(){if(isInIframe())parent.postMessage(JSON.stringify({type:"request-notify-permission"}),parentDomain);else{if(!Notification)return;"granted"!==Notification.permission&&Notification.requestPermission()}},InitFileViewer:function(){$(".dchat-message-item-child.upload-done").off("click").on("click",function(){var e=$(this).attr("data-file-url");if(""!=e){getExtentionOnly(e);window.open(storageDomain+e)}})},InitPreMessage:function(e){var t=this,n=[{title:"Tôi không thể trò chuyện lúc này",msg:"Xin chào ##fullname##, cảm ơn bạn đã liên hệ. Tôi không thể trò chuyện lúc này nhưng tôi sẽ liên hệ lại với bạn sớm nhất có thể!"},{title:"Tôi có thể giúp gì cho bạn?",msg:"Xin chào ##fullname##, cảm ơn bạn đã liên hệ. Tôi có thể giúp gì cho bạn?"}],a="";$.each(n,function(t,n){a+="<li><b>"+n.title.replace(/##fullname##/gi,e.fullname)+"</b><p>"+n.msg.replace(/##fullname##/gi,e.fullname)+"</p></li>"}),$("#dchat-pre-message-select").html(a),$("#dchat-pre-message-select li").off("click").on("click",function(){var e=$.trim($(this).find("p").text()),n="msg_"+(new Date).getTime(),a=$(".dchat-message-item:last"),i="";a.hasClass("my-message")&&(i=a.attr("data-id"));var o={conversation_id:t.ActiveConversationId,content:e,text:e,type:1,avatar:global_member.avatar,temp_id:n,parent_id:i};t.Connection.emit("message",o),o.is_my_message=!0,t.AppendMessage(o),$(".pre-message-select").addClass("popbox-hide")})},UploadManager:{MaxFileSize:20971520,Exts:"jpg|jpeg|png|gif|zip|rar",Init:function(){var e,t,n,a,i,o=this;a=[],e=function(e){return(parseFloat(e.loaded/e.total*100,10).toFixed(2)||0)+"%"},t=function(e){a[e]&&a[e].jqXHR.abort()},i=function(e){var t,n;n=a[e],t=n.context,n.uploadedBytes=parseInt($(t).attr("uploadedBytes"),10),n.data=null,$(n).submit()},n=function(e){return'<span class="bar" style="width: '+e+'">'+e+"</span>"},$("#dchat-file-select").fileupload({url:storageServiceUrl+"?fn=upload",autoUpload:!1,add:function(e,t){var n=t.files[0].name,a=getExtentionOnly(n),i=o.Exts.split("|");return i.length>0&&-1==$.inArray(a.toLowerCase(),i)?alert("Chỉ cho phép upload các định dạng: "+o.Exts.replace(/\|/g,";")):t.files[0].size>o.MaxFileSize?alert("Dung lượng file tối đa cho phép là 20MB!"):void DW.Chat.Post({data:{filename:n},url:"/chat/file-token",callback:function(e){"string"==typeof e&&(e=JSON.parse(e)),t.formData=e;var i="upload"+(new Date).getTime(),o="msg_"+(new Date).getTime();t.tempId=i;var s=$(".dchat-message-item:last"),c="";s.hasClass("my-message")&&(c=s.attr("data-id"));var l=bytesToSize(t.files[0].size),r={conversation_id:DW.Chat.ActiveConversationId,content:n+" ("+l+")",text:n+" ("+l+")",type:2,avatar:global_member.avatar,temp_id:o,parent_id:c,payload:{size:t.files[0].size,ext:a,url:"",id:i,status:0}};DW.Chat.Connection.emit("message",r),$(this).html("<br/>"),r.is_my_message=!0,DW.Chat.AppendMessage(r),t.process().done(function(){t.submit()})}})},done:function(e,t){console.log(t.tempId),"string"==typeof t.result&&(t.result=JSON.parse(t.result));var n=setInterval(function(){var e=$('.dchat-message-item-child[data-temp-file-id="'+t.tempId+'"]').attr("data-id");""==e&&(e=$('.dchat-message-item-child[data-temp-file-id="'+t.tempId+'"]').parents(".dchat-message-item").attr("data-id")),console.log(e),""!=e&&(clearInterval(n),DW.Chat.Connection.emit("message upload success",{conversation_id:DW.Chat.ActiveConversationId,id:t.tempId,url:t.result.path,message_id:e}))},100)},success:function(e,t){"string"==typeof e&&(e=JSON.parse(e));e.size,e.ext,e.path},progress:function(t,a){$("#"+a.tempId).html(n(e(a)))},fail:function(){console.log("fail")},stop:function(){console.log("stopped")}})}},InitEmoticon:function(){var e=this,t={};$.each(skypeEmo,function(e,n){var a=n.title.toLowerCase();a=a.split(" ").join("").replace(/\./g,"").replace(/'/g,"").replace(/!/g,""),n.code=n.code.replace(/  +/g," "),t[a]={title:n.title,codes:n.code.split(" "),img:n.image}});var n="",a="";$.each(t,function(e,t){n+='<li data-codes="'+t.codes.join(",")+'" title="'+t.title+'"><span class="emoticon emoticon-'+e+'"></span></li>',a+=".emoticon.emoticon-"+e+'{background:("/images/emoticons/01/'+t.img+'");}'}),$("#dchat-emoticon-select").html(n),$("#dchat-emoticon-select li").off("click").on("click",function(){var t=$(this).attr("data-codes").split(",")[0];e.Editor.insertTextAtCursor(t+" ")}),$.emoticons.define(t)},CurrentSelection:null,Editor:{saveSelection:function(){var e=this;window.getSelection?(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount&&(e.CurrentSelection=sel.getRangeAt(0))):document.selection&&document.selection.createRange&&(e.CurrentSelection=document.selection.createRange()),e.CurrentSelection=null},restoreSelection:function(e){e&&(window.getSelection?(sel=window.getSelection(),sel.removeAllRanges(),sel.addRange(e)):document.selection&&e.select&&e.select())},insertTextAtCursor:function(e){$("#dchat-input-area").get(0).focus(),""==$.trim($("#dchat-input-area").text())&&0==$(".emoticon",$("#dchat-input-area")).length&&$("#dchat-input-area").empty(),e=$.emoticons.replace(e),e+="&nbsp;";var t,n;if(window.getSelection)if(t=window.getSelection(),t.getRangeAt&&t.rangeCount){n=t.getRangeAt(0),n.collapse(!1),n.deleteContents();var a=document.createElement("div");a.innerHTML=e;for(var i,o=document.createDocumentFragment();i=a.firstChild;)o.appendChild(i);n.insertNode(o)}else $("#dchat-input-area").html(e);else document.selection&&document.selection.createRange?document.selection.createRange().html=e:$("#dchat-input-area").html(e);this.placeCaretAtEnd($("#dchat-input-area").get(0))},placeCaretAtEnd:function(e){try{if(e.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}else if(void 0!==document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.collapse(!1),a.select()}}catch(e){}}},Notifies:[],AppendMessage:function(e){function t(){document.title=s?c:l,s=!s}var a=this;if(0==$('.dchat-conversation-item[data-id="'+e.conversation_id+'"]').length)a.GetConversations(!1);else if($('.dchat-conversation-item[data-id="'+e.conversation_id+'"] i').html(e.content),0==$('[data-id="'+e._id+'"]').length&&a.ActiveConversationId==e.conversation_id){var i="",o=[];e.is_my_message&&(e.cls="my-message"),-1!=e.avatar.lastIndexOf("DekiruCharAvatar://")&&(e.avatar=e.avatar.split("DekiruCharAvatar://")[1],e.avatarCls="DekiruCharAvatar"),e.is_file=!1,2==e.type&&(e.is_file=!0),o.push(e),""==e.parent_id||null==e.parent_id?(i=a.MessageTemplate({messages:o}),$("#dchat-message-list").append($.emoticons.replace(i))):(i=a.MessageChildTemplate({child_messages:o}),$('#dchat-message-list .dchat-message-item[data-id="'+e.parent_id+'"] ul').append($.emoticons.replace(i))),a.CheckEmoticon(),$(".DekiruCharAvatar").initAvatar(),a.ScrollToBottom()}if(!a.IsActiveWindows&&!e.is_my_message){clearInterval(a.BlinkTitleInterval);var s=!0,c=a.InitTitle,l=e.text;if(a.BlinkTitleInterval=setInterval(t,700),$(window).focus(function(){clearInterval(a.BlinkTitleInterval),$("title").text(c)}),isMacintosh()||$.playSound("/sounds/newmsg.mp3"),isInIframe())parent.postMessage(JSON.stringify({type:"show-notify",payload:{title:$("#dchat-right-header").text(),body:e.text}}),parentDomain);else{if(!Notification)return;if("granted"!==Notification.permission)Notification.requestPermission();else{if(a.Notifies.length>0){for(n in a.Notifies)try{a.Notifies[n].close()}catch(e){}a.Notifies=[]}var r=new Notification("Tin nhắn mới",{icon:"images/email_notify.png",body:e.text});a.Notifies.push(r)}}}},CheckEmoticon:function(){$(".dchat-message-item-child").each(function(){$.trim($(this).text())==$.trim($(".emoticon",$(this)).text())&&$(this).addClass("emoticon-only")})},OldScrollPosition:0,ScrollToBottom:function(){var e=this,t=$("#dchat-message-list").get(0);e.EnableScroll&&(t.scrollTop=t.scrollHeight)},InitTemplate:function(){var e=this,t=$("#message-child-template").html();Handlebars.registerPartial("message-child",t);var n=$("#message-template").html();e.MessageTemplate=Handlebars.compile(n),e.MessageChildTemplate=Handlebars.compile(t)},Init:function(e){var t=this;t.InitTemplate(),t.ProcessUI(),t.GetConversations(),t.InitDesktopNotify();var n=null;$(window).on("resize",function(){clearTimeout(n),n=setTimeout(function(){t.ProcessUI()},100)}),$("#dchat-input-area").off("paste").on("paste",function(e){var t=e.originalEvent.clipboardData.getData("text");t=t.replace(/&nbsp;/g," "),e.preventDefault(),document.execCommand("insertHTML",!1,t)});var a=new Autolinker({urls:{schemeMatches:!0,wwwMatches:!0,tldMatches:!0},email:!0,phone:!0,mention:!1,hashtag:!1,stripPrefix:!1,stripTrailingSlash:!1,newWindow:!0,truncate:{length:0,location:"end"},className:"dekiru-auto-link"});$("#dchat-input-area").off("keydown").on("keydown",function(e){if(13==e.keyCode){var n=$.trim($(this).html());if(n.length>500)return alert("Nội dung quá dài! Cho phép tối đa 500 ký tự/ tin nhắn.");n=$.emoticons.replace(n);var i=$.trim($(this).text());if(""==i&&0==$(".emoticon",$(this)).length)return;var o="msg_"+(new Date).getTime(),s=$(".dchat-message-item:last"),c="";s.hasClass("my-message")&&(c=s.attr("data-id")),n=a.link(n);var l={conversation_id:t.ActiveConversationId,content:n,text:i,type:1,avatar:global_member.avatar,temp_id:o,parent_id:c};return t.Connection.emit("message",l),$(this).html("<br/>"),l.is_my_message=!0,t.AppendMessage(l),e.preventDefault(),!1}}),void 0===e&&(e={}),void 0===e.token&&console.log("DW.Chat.Init missing parameter token!");var i={onInit:function(){},onMessage:function(){},onTyping:function(){},onUpdateRead:function(){}};void 0===e.onInit&&(e.onInit=i.onInit),void 0===e.onMessage&&(e.onMessage=i.onMessage);var o=io.connect(t.Host);o.on("connect",function(){o.emit("authenticate",{token:e.token}).on("authenticated",function(){t.Connection=o}).on("unauthorized",function(e){console.log("unauthorized: "+JSON.stringify(e.data))})}),o.on("init",function(t){console.log("init"),e.onInit(t)}),o.on("error",function(e){console.log("err",e)}),o.on("message receive",function(e){console.log("receive message"),t.AppendMessage(e)}),o.on("message upload success",function(e){console.log("message upload success"),$('[data-temp-file-id="'+e.id+'"]').addClass("upload-done").attr("data-file-url",e.url),t.InitFileViewer()}),o.on("message success",function(e){$('[data-temp-id="'+e.temp_id+'"]').attr("data-id",e._id).attr("data-temp-id","")}),o.on("message error",function(e){console.log("message error",e)}),o.on("update_read",function(t){console.log("on update read"),e.onUpdateRead(t)})},MarkRead:function(e){null!=this.Connection&&this.Connection.emit("mark_read",e)},GetConversations:function(e){var t=this;void 0===e&&(e=!0),t.Post({url:"/chat/conversation",callback:function(n){if($("#dchat-left-conversation-list").append(n),$(".DekiruCharAvatar").initAvatar(),t.TimeAgo(),e){var a=$(".dchat-conversation-item:eq(0)").attr("data-id");a&&t.DetailConversation(a)}$("#dchat-left-conversation-list li.dchat-conversation-item").off("click").on("click",function(){var e=$(this).attr("data-id");t.DetailConversation(e)})}})},DetailConversation:function(e){var t=this;t.ActiveConversationId=e,$(".dchat-conversation-item").removeClass("active");var n=$('.dchat-conversation-item[data-id="'+e+'"]');n.addClass("active");var a=$("b",n).text();$("#dchat-right-header h3").text(a),t.GetMessages(e),t.ShowUserInfo(e),$(".dchat-popbox").addClass("popbox-hide"),t.MarkRead(e)},ShowUserInfo:function(e){var t=this;t.Post({url:"/chat/member/info",data:{conversation_id:e},callback:function(n){function a(){$(".delete-note").off("click").on("click",function(){var e=$(this).parents(".note-item").attr("data-id");t.Post({url:"/chat/note/remove",data:{id:e},callback:function(t){$('.note-item[data-id="'+e+'"]').fadeOut()}})})}$("#dchat-info-detail").html(n),a(),$("#show-add-note").off("click").on("click",function(){$("#add-note").show()}),$("#cancel-note").off("click").on("click",function(){$("#add-note").hide(),$("#note-txt").val("")}),$("#add-note-btn").off("click").on("click",function(){t.Post({url:"/chat/note/add",data:{conversation_id:e,content:$("#note-txt").val()},callback:function(e){$("#list-note").append('<div class="note-item" data-id="'+e._id+'">                                                        <b>'+e.content+'</b><span class="btn btn-link delete-note no-margin no-padding">Xóa</span></p>                                                    </div>'),$("#note-txt").val(""),$("#add-note").hide(),a()}})})}})},GetMessages:function(e){var t=this;$("body").loading({theme:"dark",message:"Đang tải dữ liệu..."}),t.Post({url:"/chat/message",data:{conversation_id:e},callback:function(e){$("#dchat-message-list").html(e),$("#dchat-message-list .DekiruCharAvatar").initAvatar(),$(".dchat-message-item-child>span").each(function(){$(this).html($.emoticons.replace($(this).html()))}),t.CheckEmoticon(),t.ScrollToBottom(),t.InitFileViewer(),$("body").loading("stop")}})},TimeAgo:function(){},Post:function(e){var t={token:global_token};t=$.extend({},t,e.data),t.action=e.action,$.ajax({url:e.url,data:t,xhrFields:{withCredentials:!0},type:"POST",success:function(t){"function"==typeof e.callback&&e.callback(t)}})}},$(function(){global_token&&DW.Chat.Init({token:global_token,onInit:function(e){console.log(e)}})});