(function(){function t(t,s){if(s===t)return[{value:s}];if(!s)return[{value:t,removed:!0}];if(!t)return[{value:s,added:!0}];var r=s.length,u=t.length,a=r+u,h=[{newPos:-1,components:[]}],p=i(h[0],s,t,0);if(h[0].newPos+1>=r&&p+1>=u)return[{value:s}];for(var c=1;c<=a;){var l=function(){for(var a=-1*c;a<=c;a+=2){var p,l=h[a-1],d=h[a+1];m=(d?d.newPos:0)-a,l&&(h[a-1]=void 0);var f=l&&l.newPos+1<r,g=d&&0<=m&&m<u;if(f||g){!f||g&&l.newPos<d.newPos?(p=o(d),n(p.components,void 0,!0)):(p=l,p.newPos++,n(p.components,!0,void 0));var m=i(p,s,t,a);if(p.newPos+1>=r&&m+1>=u)return e(p.components,s,t);h[a]=p}else h[a]=void 0}c++}();if(l)return l}}function e(t,e,n){for(var i=0,o=t.length,s=0,r=0;i<o;i++){var u=t[i];u.removed?(u.value=n.slice(r,r+u.count),r+=u.count):(u.value=e.slice(s,s+u.count),s+=u.count,u.added||(r+=u.count))}return t}function n(t,e,n){var i=t[t.length-1];i&&i.added===e&&i.removed===n?t[t.length-1]={count:i.count+1,added:e,removed:n}:t.push({count:1,added:e,removed:n})}function i(t,e,n,i){for(var o=e.length,s=n.length,r=t.newPos,u=r-i,a=0;r+1<o&&u+1<s&&e[r+1]==n[u+1];)r++,u++,a++;return a&&t.components.push({count:a}),t.newPos=r,u}function o(t){return{newPos:t.newPos,components:t.components.slice(0)}}var s,r,u,a,h,p,c,l=function(t,e){return function(){return t.apply(e,arguments)}},d=function(t,e){function n(){this.constructor=t}for(var i in e)f.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},f={}.hasOwnProperty,g=[].slice;c="mentionsInput",a={get:function(t){return{start:t[0].selectionStart,end:t[0].selectionEnd}},set:function(t,e,n){if(null==n&&(n=e),t[0].selectionStart)return t[0].selectStart=e,t[0].selectionEnd=n}},h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},p=function(t){return t.replace(/[&<>"'\/]/g,function(t){return h[t]})},$.widget("ui.areacomplete",$.ui.autocomplete,{options:$.extend({},$.ui.autocomplete.prototype.options,{matcher:"(\\b[^,]*)",suffix:""}),_create:function(){return this.overriden={select:this.options.select,focus:this.options.focus},this.options.select=$.proxy(this.selectCallback,this),this.options.focus=$.proxy(this.focusCallback,this),$.ui.autocomplete.prototype._create.call(this),this.matcher=new RegExp(this.options.matcher+"$")},selectCallback:function(t,e){var n,i,o,s;return s=this._value(),i=s.substring(0,this.start),n=s.substring(this.end),o=e.item.value+this.options.suffix,s=i+o+n,this._value(s),a.set(this.element,i.length+o.length),this.overriden.select&&(e.item.pos=this.start,this.overriden.select(t,e)),!1},focusCallback:function(){return!!this.overriden.focus&&this.overriden.focus(event,ui)},search:function(t,e){var n,i;if(!t){if(t=this._value(),i=a.get(this.element).start,t=t.substring(0,i),!(n=this.matcher.exec(t)))return"";this.start=n.index,this.end=n.index+n[0].length,this.searchTerm=n[1]}return $.ui.autocomplete.prototype.search.call(this,this.searchTerm,e)},_renderItem:function(t,e){var n,i,o;return i=$("<li>"),n=$("<a>").appendTo(i),e.image&&n.append('<img src="'+e.image+'" />'),o=e.value.replace(this.searchTerm.substring(),"<strong>$&</strong>"),n.append(o),i.appendTo(t)}}),$.widget("ui.editablecomplete",$.ui.areacomplete,{options:$.extend({},$.ui.areacomplete.prototype.options,{showAtCaret:!1}),selectCallback:function(t,e){var n,i;return i={start:this.start,end:this.end},(!this.overriden.select||(e.item.pos=i,!1!==this.overriden.select(t,e)))&&(n=document.createTextNode(e.item.value),insertMention(n,i,this.options.suffix),this.element.change(),!1)},search:function(t,e){var n,i,o,s;if(!t){if(s=window.getSelection(),i=s.focusNode,t=i.textContent,o=s.focusOffset,t=t.substring(0,o),!(n=this.matcher.exec(t)))return"";this.start=n.index,this.end=n.index+n[0].length,this._setDropdownPosition(i),this.searchTerm=n[1]}return $.ui.autocomplete.prototype.search.call(this,this.searchTerm,e)},_setDropdownPosition:function(t){var e,n,i,o;if(this.options.showAtCaret)return e=document.createRange(),e.setStart(t,this.start),e.collapse(!0),o=e.getClientRects()[0],n=o.left+(window.scrollX||window.pageXOffset),i=o.top+o.height+(window.scrollY||window.pageYOffset),this.options.position.of=document,this.options.position.at="left+"+n+" top+"+i}}),s=function(){function t(t,e){this.input=t,this.options=$.extend({},this.settings,e),this.options.source||(this.options.source=this.input.data("source")||[])}return t.prototype.marker="â€‹",t.prototype._getMatcher=function(){var t;return t="[^"+this.options.trigger+"]","\\B["+this.options.trigger+"]("+t+"{0,20})"},t.prototype._markupMention=function(t){return"@["+t.name+"]("+t.uid+")"},t}(),u=function(e){function n(t,e){var i;this.input=t,this._updateHScroll=l(this._updateHScroll,this),this._updateVScroll=l(this._updateVScroll,this),this._updateValue=l(this._updateValue,this),this._onSelect=l(this._onSelect,this),this._addMention=l(this._addMention,this),this._updateMentions=l(this._updateMentions,this),this._update=l(this._update,this),this.settings={trigger:"@",widget:"areacomplete",suffix:"",autocomplete:{autoFocus:!0,delay:0}},n.__super__.constructor.call(this,this.input,e),this.mentions=[],this.input.addClass("input"),i=$("<div>",{class:"mentions-input"}),i.css("display",this.input.css("display")),this.container=this.input.wrapAll(i).parent(),this.hidden=this._createHidden(),this.highlighter=this._createHighlighter(),this.highlighterContent=$("div",this.highlighter),this.input.focus(function(t){return function(){return t.highlighter.addClass("focus")}}(this)).blur(function(t){return function(){return t.highlighter.removeClass("focus")}}(this)),e=$.extend({matcher:this._getMatcher(),select:this._onSelect,suffix:this.options.suffix,source:this.options.source,appendTo:this.input.parent()},this.options.autocomplete),this.autocomplete=this.input[this.options.widget](e),this._setValue(this.input.val()),this._initEvents()}var i;return d(n,e),i=["backgroundColor","marginTop","marginBottom","marginLeft","marginRight","paddingTop","paddingBottom","paddingLeft","paddingRight","borderTopWidth","borderLeftWidth","borderBottomWidth","borderRightWidth","fontSize","fontStyle","fontFamily","fontWeight","lineHeight","height","boxSizing"],n.prototype._initEvents=function(){var t;return this.input.on("input."+c+" change."+c,this._update),t=this.input.prop("tagName"),"INPUT"===t?(this.input.on("focus."+c,function(t){return function(){return t.interval=setInterval(t._updateHScroll,10)}}(this)),this.input.on("blur."+c,function(t){return function(){return setTimeout(t._updateHScroll,10),clearInterval(t.interval)}}(this))):"TEXTAREA"===t?(this.input.on("scroll."+c,function(t){return function(){return setTimeout(t._updateVScroll,10)}}(this)),this.input.on("resize."+c,function(t){return function(){return setTimeout(t._updateVScroll,10)}}(this))):void 0},n.prototype._setValue=function(t){var e,n,i;for(i=0,n=/@\[([^\]]+)\]\(([^ \)]+)\)/g,this.value=t.replace(n,"$1"),this.input.val(this.value),e=n.exec(t);e;)this._addMention({name:e[1],uid:e[2],pos:e.index-i}),i+=e[2].length+5,e=n.exec(t);return this._updateValue()},n.prototype._createHidden=function(){var t;return t=$("<input>",{type:"hidden",name:this.input.attr("name")}),t.appendTo(this.container),this.input.removeAttr("name"),t},n.prototype._createHighlighter=function(){var t,e,n,o,s;for(e=$("<div>",{class:"highlighter"}),"INPUT"===this.input.prop("tagName")?e.css("whiteSpace","pre"):(e.css("whiteSpace","pre-wrap"),e.css("wordWrap","break-word")),t=$("<div>",{class:"highlighter-content"}),e.append(t).prependTo(this.container),n=0,o=i.length;n<o;n++)s=i[n],e.css(s,this.input.css(s));return this.input.css("backgroundColor","transparent"),e},n.prototype._update=function(){return this._updateMentions(),this._updateValue()},n.prototype._updateMentions=function(){var e,n,i,o,s,r,u,a,h,p,c,l;for(l=this.input.val(),i=t(this.value,l),c=function(t){return function(e,n){var i,o,s,r,u;for(r=t.mentions,u=[],i=0,o=r.length;i<o;i++)s=r[i],s.pos>=e?u.push(s.pos+=n):u.push(void 0);return u}}(this),n=0,s=0,u=i.length;s<u;s++)e=i[s],e.added?c(n,e.count):e.removed&&c(n,-e.count),e.removed||(n+=e.count);for(p=this.mentions.slice(0),o=r=p.length-1;r>=0;o=r+=-1)a=p[o],h=l.substring(a.pos,a.pos+a.name.length),a.name!==h&&this.mentions.splice(o,1);return this.value=l},n.prototype._addMention=function(t){return this.mentions.push(t),this.mentions.sort(function(t,e){return t.pos-e.pos})},n.prototype._onSelect=function(t,e){return this._updateMentions(),this._addMention({name:e.item.value,pos:e.item.pos,uid:e.item.uid}),this._updateValue()},n.prototype._updateValue=function(){var t,e,n,i,o,s,r,u,a;for(a=this.input.val(),n=[],e=[],t=0,u=this.mentions,i=0,o=u.length;i<o;i++)s=u[i],r=a.substring(t,s.pos),n.push(p(r)),e.push(r),n.push("<strong>"+s.name+"</strong>"),e.push(this._markupMention(s)),t=s.pos+s.name.length;return r=a.substring(t),this.highlighterContent.html(n.join("")+p(r)),this.hidden.val(e.join("")+r)},n.prototype._updateVScroll=function(){var t;return t=this.input.scrollTop(),this.highlighterContent.css({top:"-"+t+"px"}),this.highlighter.height(this.input.height())},n.prototype._updateHScroll=function(){var t;return t=this.input.scrollLeft(),this.highlighterContent.css({left:"-"+t+"px"})},n.prototype._replaceWithSpaces=function(t,e){return t.replace(e,Array(e.length).join(" "))},n.prototype._cutChar=function(t,e){return t.substring(0,e)+t.substring(e+1)},n.prototype.setValue=function(){var t,e,n,i,o;for(i=1<=arguments.length?g.call(arguments,0):[],o="",t=0,e=i.length;t<e;t++)n=i[t],o+="string"==typeof n?n:this._markupMention(n);return this._setValue(o)},n.prototype.getValue=function(){return this.hidden.val()},n.prototype.getRawValue=function(){return this.input.val().replace(this.marker,"")},n.prototype.getMentions=function(){return this.mentions},n.prototype.clear=function(){return this.input.val(""),this._update()},n.prototype.destroy=function(){return this.input.areacomplete("destroy"),this.input.off("."+c).attr("name",this.hidden.attr("name")),this.container.replaceWith(this.input)},n}(s),r=function(t){function e(t,n){this.input=t,this._onSelect=l(this._onSelect,this),this._addMention=l(this._addMention,this),this.settings={trigger:"@",widget:"editablecomplete",autocomplete:{autoFocus:!0,delay:0}},e.__super__.constructor.call(this,this.input,n),n=$.extend({matcher:this._getMatcher(),suffix:this.marker,select:this._onSelect,source:this.options.source,showAtCaret:this.options.showAtCaret},this.options.autocomplete),this.autocomplete=this.input[this.options.widget](n),this._setValue(this.input.html()),this._initEvents()}var n,i;return d(e,t),e.prototype.selector="[data-mention]",i=function(t){return'<span class="dekiru-mention" data-mention="'+t.uid+'">@'+t.value+"</span> "},n=function(t,e,n){var i,o,s;s=window.getSelection(),i=s.focusNode,o=s.getRangeAt(0);try{o.setStart(i,e.start),o.setEnd(i,e.end)}catch(t){console.log(t)}return o.deleteContents(),o.insertNode(t),n?(n=document.createTextNode(n),$(n).insertAfter(t),o.setStartAfter(n)):o.setStartAfter(t),o.collapse(!0),s.removeAllRanges(),s.addRange(o),t},e.prototype._initEvents=function(){return this.input.find(this.selector).each(function(t){return function(e,n){return t._watch(n)}}(this))},e.prototype._setValue=function(t){var e;return e=/@\[([^\]]+)\]\(([^ \)]+)\)/g,t=t.replace(e,function(t){return function(e,n,o){return i({value:n,uid:o})+t.marker}}(this)),this.input.html(t)},e.prototype._addMention=function(t){var e,o;return o=$(i(t))[0],t.pos||(t.pos={start:0,end:0},this.setValue(this.input.html())),e=n(o,t.pos,this.marker),this._watch(e)},e.prototype._onSelect=function(t,e){return this._addMention(e.item),this.input.trigger("change."+c),!1},e.prototype._watch=function(t){return t.addEventListener("DOMCharacterDataModified",function(e){var n,i,o,s;if(e.newValue!==e.prevValue)return s=e.target,o=window.getSelection(),n=o.focusOffset,$(s).insertBefore(t),$(t).remove(),i=document.createRange(),i.setStart(s,n),i.collapse(!0),o.removeAllRanges(),o.addRange(i)})},e.prototype.update=function(){return this._initValue(),this._initEvents(),this.input.focus()},e.prototype.setValue=function(){var t,e,n,i,o;for(i=1<=arguments.length?g.call(arguments,0):[],o="",t=0,e=i.length;t<e;t++)n=i[t],o+="string"==typeof n?n:this._markupMention(n);return this._setValue(o),this._initEvents(),this.input.focus()},e.prototype.getValue=function(){var t,e;return e=this.input.clone(),t=this._markupMention,$(this.selector,e).replaceWith(function(){var e,n;return n=$(this).data("mention"),e=$(this).text(),t({name:e,uid:n})}),e.html().replace(this.marker,"")},e.prototype.getMentions=function(){var t;return t=[],$(this.selector,this.input).each(function(){return t.push({uid:$(this).data("mention"),name:$(this).text()})}),t},e.prototype.clear=function(){return this.input.html("")},e.prototype.destroy=function(){return this.input.editablecomplete("destroy"),this.input.off("."+c),this.input.html(this.getValue())},e}(s),$.fn[c]=function(){var t,e,n;return e=arguments[0],t=2<=arguments.length?g.call(arguments,1):[],n=this,this.each(function(){var i,o;if("string"==typeof e&&"_"!==e.charAt(0)){if(i=$(this).data("mentionsInput"),e in i)return n=i[e].apply(i,t)}else{if("INPUT"===(o=this.tagName)||"TEXTAREA"===o)return $(this).data("mentionsInput",new u($(this),e));if("true"===this.contentEditable)return $(this).data("mentionsInput",new r($(this),e))}}),n}}).call(this);