"undefined"==typeof DW&&(DW={}),DW.Chat={Host:realtimeDomain+"/chat-room",Connection:null,ActiveConversationId:"",EnableScroll:!0,IsActiveWindows:!1,InitTitle:"Hỗ trợ trực tuyến",BlinkTitleInterval:null,MenuLevel:0,Level:0,DefaultRoom:"jlptn0",ProcessUI:function(){var e=this;e.InitEmoticon(),e.UploadManager.Init(),document.execCommand("defaultParagraphSeparator",!1,"p"),e.Editor.placeCaretAtEnd($("#dchat-input-area").get(0)),$("#dchat-input-area").blur(),$("#dchat-left, #dchat-right").css({height:$(window).height()}),$("#dchat-left-conversation-list-wrapper").css({height:$(window).height()}),getParameterByName("menu")&&(e.MenuLevel=getParameterByName("menu")),getParameterByName("level")&&(e.Level=getParameterByName("level")),getParameterByName("room")&&(e.DefaultRoom=getParameterByName("room"),0==$('#dchat-left-conversation-list li[data-id="'+e.DefaultRoom+'"]').length&&($("#dchat-menu-trigger").hide(),$("#dchat-info-overlay h3").text("#chat"),$("#dchat-info-overlay p").hide(),$("#dchat-info").hide())),$("#dchat-info-overlay").particleground({sizeDependConnections:!1,randomBounceSides:!1}),$("#dchat-wrapper").addClass("menu-level-"+e.MenuLevel),1==e.MenuLevel?$("#dchat-wrapper").addClass("menu-visible"):2==e.MenuLevel||$("#dchat-menu-trigger").off("click").on("click",function(){$(this).hide(),$("#dchat-left").animate({"margin-left":0},300),$("#dchat-right").animate({"margin-right":-100,opacity:.2},250)}),$("#dchat-message-list").css({height:$(window).height()-50-($("#dchat-info").is(":visible")?100:0)}),$("#dchat-show-hide-info").off("click").on("click",function(){$(this).toggleClass("active"),$("#dchat-info").toggleClass("active"),$("#dchat-main-left").toggleClass("minimized")}),$("#dchat-filter-conversation").off("click").on("click",function(){$(this).toggleClass("active"),$("#dchat-filter-select").toggleClass("active")}),$("[contenteditable='true']").off("focus").on("focus",function(){var e=$(this);0==$("br",e).length&&""==$.trim(e.text())&&0==$(".emoticon",e).length&&e.html(e.html()+"<br/>")}),$("[contenteditable='true']").off("blur").on("blur",function(){e.Editor.saveSelection();var t=$(this);t.text().trim().length||0!=$(".emoticon",t).length||t.empty()}),$("#dchat-input-func span.emoticon").off("click").on("click",function(){$(this).toggleClass("active"),$(".dchat-popbox.pre-message-select").addClass("popbox-hide"),$(".dchat-popbox.emoticon-select").toggleClass("popbox-hide")}),$("#dchat-input-func span.pre-message").off("click").on("click",function(){e.InitPreMessage({fullname:$("#dchat-right-header h3").text()}),$(this).toggleClass("active"),$(".dchat-popbox.emoticon-select").addClass("popbox-hide"),$(".dchat-popbox.pre-message-select").toggleClass("popbox-hide")}),$("#dchat-message-list").on("scroll",function(t){var n,a,i,o;n=$(this),o=n.scrollTop(),i=n.prop("scrollHeight"),a=n.height(),o<i-a-50&&(e.EnableScroll=!1),o>i-a-30&&(e.EnableScroll=!0)}),$(window).on("blur focus",function(t){if($(this).data("prevType")!=t.type)switch(t.type){case"blur":e.IsActiveWindows=!1;break;case"focus":e.IsActiveWindows=!0}$(this).data("prevType",t.type)}),e.InitMention()},MentionSource:[{value:"Anh Tú",uid:"10015"}],MentionSourceUpdate:function(){var e=this;e.MentionSource=[],$(".deriku-image-wraper").each(function(){var t=$(this).attr("data-member"),n=$(this).parent().find(".dchat-message-sender-name").text(),a={value:n,uid:t};0==e.MentionSource.filter(function(e){return e.uid==t}).length&&t!=global_member.user_id&&0!=t&&e.MentionSource.push(a)}),0==e.MentionSource.length&&10015==global_member.user_id&&(e.MentionSource=[{value:"Anh Tú",uid:"10015"},{value:"Hoàng Hà",uid:"10016"},{value:"Anh Tuấn",uid:"10017"}])},InitMention:function(){var e=this,t=$("#dchat-input-area").mentionsInput({source:function(t,n){n($.ui.autocomplete.filter(e.MentionSource,t.term).slice(0,10))},showAtCaret:!0,autocomplete:{position:{my:"left bottom-25",at:"right top",collision:"flip"},autoFocus:!0,select:function(n,a){return console.log(2),e.IsMentionProcessing=!0,t=$("#dchat-input-area").data("mentionsInput"),t._onSelect(n,a),setTimeout(function(){e.IsMentionProcessing=!1},200),n.preventDefault(),!1}}})},InitDesktopNotify:function(){if(isInIframe())parent.postMessage(JSON.stringify({type:"request-notify-permission"}),parentDomain);else{if(!Notification)return;"granted"!==Notification.permission&&Notification.requestPermission()}},InitFileViewer:function(){$(".dchat-message-item-child.upload-done").off("click").on("click",function(){var e=$(this).attr("data-file-url");if(""!=e){getExtentionOnly(e);window.open(storageDomain+e)}})},UploadManager:{MaxFileSize:20971520,Exts:"jpg|jpeg|png|gif|zip|rar",Init:function(){var e,t,n,a,i,o=this;a=[],e=function(e){return(parseFloat(e.loaded/e.total*100,10).toFixed(2)||0)+"%"},t=function(e){a[e]&&a[e].jqXHR.abort()},i=function(e){var t,n;n=a[e],t=n.context,n.uploadedBytes=parseInt($(t).attr("uploadedBytes"),10),n.data=null,$(n).submit()},n=function(e){return'<span class="bar" style="width: '+e+'">'+e+"</span>"},$("#dchat-file-select").fileupload({url:storageServiceUrl+"?fn=upload",autoUpload:!1,add:function(e,t){var n=t.files[0].name,a=getExtentionOnly(n),i=o.Exts.split("|");return i.length>0&&-1==$.inArray(a.toLowerCase(),i)?alert("Chỉ cho phép upload các định dạng: "+o.Exts.replace(/\|/g,";")):t.files[0].size>o.MaxFileSize?alert("Dung lượng file tối đa cho phép là 20MB!"):void DW.Chat.Post({data:{filename:n},url:"/chat/file-token",callback:function(e){"string"==typeof e&&(e=JSON.parse(e)),t.formData=e;var i="upload"+(new Date).getTime(),o="msg_"+(new Date).getTime();t.tempId=i;var s=$(".dchat-message-item:last"),c="";s.hasClass("my-message")&&(c=s.attr("data-id"));var l=bytesToSize(t.files[0].size),r={conversation_id:DW.Chat.ActiveConversationId,content:n+" ("+l+")",text:n+" ("+l+")",type:2,name:global_member.name,avatar:global_member.avatar,temp_id:o,parent_id:c,payload:{size:t.files[0].size,ext:a,url:"",id:i,status:0}};DW.Chat.Connection.emit("message",r),$(this).html("<br/>"),r.is_my_message=!0,DW.Chat.AppendMessage(r),t.process().done(function(){t.submit()})}})},done:function(e,t){console.log(t.tempId),"string"==typeof t.result&&(t.result=JSON.parse(t.result));var n=setInterval(function(){var e=$('.dchat-message-item-child[data-temp-file-id="'+t.tempId+'"]').attr("data-id");""==e&&(e=$('.dchat-message-item-child[data-temp-file-id="'+t.tempId+'"]').parents(".dchat-message-item").attr("data-id")),console.log(e),""!=e&&(clearInterval(n),DW.Chat.Connection.emit("message upload success",{conversation_id:DW.Chat.ActiveConversationId,id:t.tempId,url:t.result.path,message_id:e}))},100)},success:function(e,t){"string"==typeof e&&(e=JSON.parse(e));e.size,e.ext,e.path},progress:function(t,a){$("#"+a.tempId).html(n(e(a)))},fail:function(){console.log("fail")},stop:function(){console.log("stopped")}})}},InitEmoticon:function(){var e=this,t={};$.each(skypeEmo,function(e,n){var a=n.title.toLowerCase();a=a.split(" ").join("").replace(/\./g,"").replace(/'/g,"").replace(/!/g,""),n.code=n.code.replace(/  +/g," "),t[a]={title:n.title,codes:n.code.split(" "),img:n.image}});var n="",a="";$.each(t,function(e,t){n+='<li data-codes="'+t.codes.join(",")+'" title="'+t.title+'"><span class="emoticon emoticon-'+e+'"></span></li>',a+=".emoticon.emoticon-"+e+'{background:("/images/emoticons/01/'+t.img+'");}'}),$("#dchat-emoticon-select").html(n),$("#dchat-emoticon-select li").off("click").on("click",function(){var t=$(this).attr("data-codes").split(",")[0];e.Editor.insertTextAtCursor(t+" ")}),$.emoticons.define(t)},CurrentSelection:null,Editor:{saveSelection:function(){var e=this;window.getSelection?(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount&&(e.CurrentSelection=sel.getRangeAt(0))):document.selection&&document.selection.createRange&&(e.CurrentSelection=document.selection.createRange()),e.CurrentSelection=null},restoreSelection:function(e){e&&(window.getSelection?(sel=window.getSelection(),sel.removeAllRanges(),sel.addRange(e)):document.selection&&e.select&&e.select())},insertTextAtCursor:function(e){$("#dchat-input-area").get(0).focus(),""==$.trim($("#dchat-input-area").text())&&0==$(".emoticon",$("#dchat-input-area")).length&&$("#dchat-input-area").empty(),e=$.emoticons.replace(e),e+="&nbsp;";var t,n;if(window.getSelection)if(t=window.getSelection(),t.getRangeAt&&t.rangeCount){n=t.getRangeAt(0),n.collapse(!1),n.deleteContents();var a=document.createElement("div");a.innerHTML=e;for(var i,o=document.createDocumentFragment();i=a.firstChild;)o.appendChild(i);n.insertNode(o)}else $("#dchat-input-area").html(e);else document.selection&&document.selection.createRange?document.selection.createRange().html=e:$("#dchat-input-area").html(e);this.placeCaretAtEnd($("#dchat-input-area").get(0))},placeCaretAtEnd:function(e){try{if(e.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}else if(void 0!==document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.collapse(!1),a.select()}}catch(e){}}},Notifies:[],AppendMessage:function(e){var t=this;if(0==$('[data-id="'+e._id+'"]').length&&t.ActiveConversationId==e.conversation_id){var n="",a=[];e.is_file=!1,2==e.type&&(e.is_file=!0),-1!=e.avatar.lastIndexOf("DekiruCharAvatar://")&&(e.avatar=e.avatar.split("DekiruCharAvatar://")[1],e.avatarCls="DekiruCharAvatar"),a.push(e),n=t.MessageTemplate({messages:a}),$(".empty-message").hide(),$("#dchat-message-list").append($.emoticons.replace(n)),t.CheckEmoticon(),$(".DekiruCharAvatar").initAvatar(),t.ScrollToBottom()}},CheckEmoticon:function(){$(".dchat-message-item-child").each(function(){$.trim($(this).text())==$.trim($(".emoticon",$(this)).text())&&$(this).addClass("emoticon-only")})},OldScrollPosition:0,ScrollToBottom:function(){var e=this,t=$("#dchat-message-list").get(0);e.EnableScroll&&(t.scrollTop=t.scrollHeight)},InitTemplate:function(){var e=this;Handlebars.registerHelper("moment",function(e,t){return moment(e).locale("vi").fromNow().replace("trước","")});var t=$("#message-template").html();e.MessageTemplate=Handlebars.compile(t)},IsMentionProcessing:!1,Init:function(e){var t=this;t.InitTemplate(),t.ProcessUI();var n=null;$(window).on("resize",function(){clearTimeout(n),n=setTimeout(function(){t.ProcessUI()},100)}),$("#dchat-input-area").off("paste").on("paste",function(e){var t=e.originalEvent.clipboardData.getData("text");t=t.replace(/&nbsp;/," "),e.preventDefault(),document.execCommand("insertHTML",!1,t)});var a=0;setInterval(function(){a>0&&a--},1e3);var i=new Autolinker({urls:{schemeMatches:!0,wwwMatches:!0,tldMatches:!0},email:!0,phone:!0,mention:!1,hashtag:!1,stripPrefix:!1,stripTrailingSlash:!1,newWindow:!0,truncate:{length:0,location:"end"},className:"dekiru-auto-link"});$("#dchat-input-area").on("keydown",function(e){var n=$(this);13==e.keyCode&&(e.preventDefault(),setTimeout(function(){if(!t.IsMentionProcessing){if(++a>3)return e.preventDefault(),a=13,alert("Bạn đang gửi tin nhắn quá nhanh! Hãy chờ 10s trước khi tiếp tục!");var o=$.trim(n.html()),s=$("<div/>").html(o);if($("script,link,meta,style",s).remove(),$("h1,h2,h3,h4,h5,div",s).replaceWith(function(){return"<p>"+s(this).text()+"</p>"}),$("*",s).removeAttr("style"),o=s.html(),o.length>500)return alert("Nội dung quá dài! Cho phép tối đa 500 ký tự/ tin nhắn.");o=$.emoticons.replace(o);var c=$.trim(n.text());if(""==c&&0==$(".emoticon",n).length)return;var l="msg_"+(new Date).getTime();o=i.link(o);var r={conversation_id:t.ActiveConversationId,content:o,text:c,type:1,avatar:global_member.avatar,name:global_member.name,temp_id:l};return t.Connection.emit("message",r),n.html("<br/>"),r.is_my_message=!0,t.AppendMessage(r),e.preventDefault(),!1}},100))}),void 0===e&&(e={}),void 0===e.token&&console.log("DW.Chat.Init missing parameter token!");var o={onInit:function(){},onMessage:function(){},onTyping:function(){},onUpdateRead:function(){}};void 0===e.onInit&&(e.onInit=o.onInit),void 0===e.onMessage&&(e.onMessage=o.onMessage);var s=io.connect(t.Host);s.on("connect",function(){s.emit("authenticate",{token:e.token}).off("authenticated").on("authenticated",function(){t.Connection=s,t.ConversationInited||(t.ConversationInited=!0,t.GetConversations()),""!=t.ActiveConversationId&&t.JoinConversation(t.ActiveConversationId)}).on("unauthorized",function(e){console.log("unauthorized: "+JSON.stringify(e.data))})}),s.on("init",function(t){console.log("init"),e.onInit(t)}),s.on("error",function(e){console.log("err",e)}),s.on("message receive",function(e){console.log("receive message"),t.AppendMessage(e)}),s.on("message upload success",function(e){console.log("message upload success"),$('[data-temp-file-id="'+e.id+'"]').addClass("upload-done").attr("data-file-url",e.url),t.InitFileViewer()}),s.on("message success",function(e){$('[data-temp-id="'+e.temp_id+'"]').attr("data-id",e._id).attr("data-temp-id","")}),s.on("message error",function(e){console.log("message error",e)}),s.on("update_read",function(t){console.log("on update read"),e.onUpdateRead(t)})},ConversationInited:!1,GetConversations:function(e){var t=this;void 0===e&&(e=!0),t.Post({url:"/chat-room/conversation",callback:function(n){if($("#dchat-left-conversation-list").append(n),e){var a=$("#dchat-left-conversation-list li:eq(0)").attr("data-id");t.DefaultRoom&&(a=t.DefaultRoom),a&&t.DetailConversation(a)}$("#dchat-left-conversation-list li").off("click").on("click",function(){var e=$(this).attr("data-level");if(e>0&&t.Level>e)return alert("Trình độ của bạn chưa đủ để truy cập vào nhóm này! Hãy thi đánh giá năng lực để tiếp tục!");var n=$(this).attr("data-id");t.DetailConversation(n),0==t.MenuLevel&&($("#dchat-menu-trigger").show(),$("#dchat-left").animate({"margin-left":-100},250),$("#dchat-right").animate({"margin-right":0,opacity:1},300))})}})},DetailConversation:function(e){var t=this;t.ActiveConversationId=e,$("#dchat-left-conversation-list-wrapper").removeClass().addClass(e),$("#dchat-left-conversation-list li").removeClass("active");var n=$('#dchat-left-conversation-list li[data-id="'+e+'"]');if(n.length>0){n.addClass("active");var a=n.text();$("#dchat-info-overlay h3").text("#"+a),$("#dchat-info-overlay p").text(n.attr("data-desc"))}t.GetMessages(e,function(){t.JoinConversation(e),t.MentionSourceUpdate()}),$(".dchat-popbox").addClass("popbox-hide")},ShowUserInfo:function(e){this.Post({url:"/chat-room/member-list",data:{level:e.replace("jlptn","")},callback:function(e){$("#dchat-info-detail").html(e),$("#dchat-info-detail .DekiruCharAvatar").initAvatar()}})},JoinConversation:function(e){DW.Chat.Connection.emit("join room",e)},LeaveConversation:function(e){DW.Chat.Connection.emit("leave room",e)},GetMessages:function(e,t){var n=this;n.Post({url:"/chat-room/message",data:{conversation_id:e},callback:function(e){$("#dchat-message-list").html(e),$("#dchat-message-list .DekiruCharAvatar").initAvatar(),$(".dchat-message-item-child>span").each(function(){$(this).html($.emoticons.replace($(this).html()))}),n.CheckEmoticon(),n.ScrollToBottom(),n.InitFileViewer(),void 0!==t&&t()}})},TimeAgo:function(){},Post:function(e){var t={token:global_token};t=$.extend({},t,e.data),t.action=e.action,$.ajax({url:e.url,data:t,xhrFields:{withCredentials:!0},type:"POST",success:function(t){"function"==typeof e.callback&&e.callback(t)}})}},$(function(){global_token&&DW.Chat.Init({token:global_token,onInit:function(e){console.log(e)}})});